<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- Viewport Settings for iOS PWA: Disable Zoom, Handle Notch -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Settings for iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PureAudio">
    <meta name="theme-color" content="#000000">

    <title>Pure Black Audio v2</title>
    
    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>

    <!-- Auto-Generated App Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23000000'/%3E%3Ccircle cx='256' cy='256' r='200' fill='none' stroke='%233b82f6' stroke-width='20' opacity='0.5'/%3E%3Cpath d='M180 160h120v180c0 33-27 60-60 60s-60-27-60-60' fill='none' stroke='%23ffffff' stroke-width='30' stroke-linecap='round' stroke-linejoin='round'/%3E%3Ccircle cx='240' cy='340' r='40' fill='%233b82f6'/%3E%3C/svg%3E">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@300;500;700;800&display=swap');
        
        :root {
            --primary: #ffffff;
            --accent: #3b82f6;
            --accent-rgb: 59, 130, 246;
            --bg-color: #000000;
            --glass-border: rgba(255, 255, 255, 0.1);
            --title-glow: 20px;
            --title-glow-str: 0.8;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        body {
            font-family: 'Manrope', sans-serif;
            overflow: hidden;
            background-color: var(--bg-color);
            color: white;
            user-select: none;
            -webkit-user-select: none; 
            -webkit-tap-highlight-color: transparent; 
            touch-action: manipulation; 
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

        #bg-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
            opacity: 0.3;
            pointer-events: none;
        }

        .modern-dock {
            background: rgba(10, 10, 10, 0.85); 
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            border-radius: 32px; 
            transition: all 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            transform: translateY(0);
            opacity: 1;
            padding-bottom: max(1.25rem, var(--safe-bottom)) !important; 
        }

        .modern-dock.dock-hidden {
            transform: translateY(200%);
            opacity: 0;
            pointer-events: none;
        }

        /* Unified Settings Pill Style */
        .settings-pill {
            background: rgba(15, 15, 20, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            position: absolute;
            /* Positioning logic adjusted for safe area */
            top: calc(60px + var(--safe-top)); 
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 40;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px; /* Reduced padding for mobile fit */
            
            /* CRITICAL FIX FOR IPHONE WIDTH */
            width: 90vw; /* Takes 90% of screen width */
            max-width: 320px; /* Caps at 320px */
            max-height: 60vh;
            overflow-y: auto;
        }

        .settings-pill.active {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        #viz-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
            pointer-events: none; 
        }

        #art-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }

        #text-info-container {
            position: absolute;
            width: 100%;
            top: 40%;
            left: 0;
            transform: translateY(-50%);
            transition: top 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
            text-align: center;
            z-index: 10;
            padding: 0 1.5rem;
        }

        /* --- TITLE MASKING --- */
        #track-title {
            background-image: 
                repeating-linear-gradient(60deg, transparent 0%, rgba(255,255,255,0.1) 10%, rgba(255,255,255,0.8) 20%, rgba(255,255,255,0.1) 30%, transparent 40%),
                repeating-linear-gradient(-60deg, transparent 0%, rgba(255,255,255,0.1) 10%, rgba(255,255,255,0.8) 20%, rgba(255,255,255,0.1) 30%, transparent 40%),
                linear-gradient(to bottom, #ffffff 0%, var(--accent) 50%, #000000 100%);
            background-size: 200% 200%;
            display: inline-block;
            line-height: 1.1;
            padding: 0.2em 0.1em;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            animation: triangleMotion 8s linear infinite;
            filter: drop-shadow(0 0 var(--title-glow) rgba(var(--accent-rgb), var(--title-glow-str)));
        }

        @keyframes triangleMotion {
            0% { background-position: 0% 0%, 0% 0%, 50% 0%; }
            50% { background-position: 100% 100%, 100% 0%, 50% 100%; }
            100% { background-position: 0% 0%, 0% 0%, 50% 0%; }
        }

        .btn-icon { transition: all 0.2s; color: rgba(255,255,255,0.6); }
        .btn-icon:hover { color: white; background: rgba(255,255,255,0.05); }
        .btn-icon:active { transform: scale(0.92); }

        .btn-play { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .btn-play:hover { transform: scale(1.1); }
        .btn-play:active { transform: scale(0.95); }

        /* Range Slider Styling optimized for touch */
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; padding: 10px 0; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: white; margin-top: -7px; 
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 2px; background: #333; border-radius: 2px; }
        #seek-slider::-webkit-slider-runnable-track { background: linear-gradient(to right, white 0%, white var(--progress, 0%), #333 var(--progress, 0%), #333 100%); height: 4px; }

        #playlist-drawer {
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            background: #050505; border-left: 1px solid #222;
            padding-top: var(--safe-top); 
        }
        #playlist-drawer.closed { transform: translateX(100%); }
        
        .playlist-item { border-bottom: 1px solid #111; }
        .playlist-item.active { background: #111; color: white; }

        #custom-theme-picker { position: absolute; opacity: 0; pointer-events: none; z-index: -10; }

        /* Top Bar iOS Adjustment */
        .top-controls {
            top: max(1.0rem, var(--safe-top));
            left: 0;
            width: 100%;
            padding: 0 max(1.5rem, env(safe-area-inset-right));
            padding-left: max(1.5rem, env(safe-area-inset-left));
        }
        
        .control-btn-group {
            display: flex;
            gap: 8px;
        }

        .glass-btn {
            padding: 10px;
            border-radius: 9999px;
            background: rgba(0,0,0,0.5);
            color: #9ca3af;
            border: 1px solid rgba(255,255,255,0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            transition: all 0.2s;
        }
        .glass-btn:active { background: rgba(255,255,255,0.15); color: white; transform: scale(0.95); }
        .glass-btn.active-state { color: white; border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); }
    </style>
</head>
<body class="h-screen w-screen relative bg-black overflow-hidden">

    <canvas id="bg-canvas"></canvas>

    <div id="viz-container">
        <canvas id="art-canvas"></canvas>
        <div id="text-info-container">
            <div id="player-status" class="text-[10px] font-mono text-blue-400 mb-2 opacity-0 transition-opacity">READY</div>
            <!-- Title resized slightly to prevent cutoff on very small screens -->
            <h1 id="track-title" class="text-4xl md:text-7xl font-bold tracking-tighter leading-none pb-2 break-words">NO AUDIO</h1>
            <p id="track-artist" class="text-xs md:text-sm font-bold text-gray-400 mt-6 tracking-[0.3em] uppercase">Select Local File</p>
            <p id="track-album" class="text-[10px] md:text-xs font-medium text-gray-600 mt-2 tracking-widest uppercase opacity-0 transition-opacity duration-500">Unknown Album</p>
        </div>
    </div>

    <!-- Hidden Input for Custom Color -->
    <input type="color" id="custom-theme-picker">

    <!-- VIZ SETTINGS PILL (Floating) -->
    <div id="viz-settings-pill" class="settings-pill custom-scrollbar">
        <div class="flex justify-between items-center border-b border-white/10 pb-2 mb-1">
            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Visualizer</span>
            <button id="close-viz-pill" class="text-gray-500 hover:text-white p-2"><i data-lucide="x" class="w-4 h-4"></i></button>
        </div>
        
        <div class="space-y-4">
             <div>
                <div class="flex justify-between text-xs mb-1 text-gray-300"><span>Sensitivitas</span><span id="pill-sens-display" class="font-mono text-[10px] text-blue-400">2.5x</span></div>
                <input type="range" id="pill-sens-slider" min="5" max="50" value="25" class="w-full">
            </div>

            <div>
                <div class="flex justify-between text-xs mb-1 text-gray-300"><span>Jumlah Bar</span><span id="bar-cnt-display" class="font-mono text-[10px] text-blue-400">80</span></div>
                <input type="range" id="bar-cnt-slider" min="32" max="100" step="4" value="80" class="w-full">
            </div>
            
             <div class="grid grid-cols-2 gap-3">
                <div>
                    <div class="flex justify-between text-xs mb-1 text-gray-300"><span>Radius</span><span id="inner-radius-display" class="font-mono text-[10px] text-blue-400">12%</span></div>
                    <input type="range" id="inner-radius-slider" min="5" max="30" value="12" class="w-full">
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1 text-gray-300"><span>Panjang</span><span id="bar-len-display" class="font-mono text-[10px] text-blue-400">100%</span></div>
                    <input type="range" id="bar-len-slider" min="10" max="250" value="100" class="w-full">
                </div>
            </div>

             <div>
                <div class="flex justify-between text-xs mb-1 text-gray-300"><span>Kecepatan</span><span id="rot-speed-display" class="font-mono text-[10px] text-blue-400">1.0x</span></div>
                <input type="range" id="rot-speed-slider" min="0" max="50" step="1" value="10" class="w-full">
            </div>
        </div>
    </div>

    <!-- MAIN CONFIG PILL (Floating - Moved from Dock) -->
    <div id="main-settings-pill" class="settings-pill custom-scrollbar">
        <div class="flex justify-between items-center border-b border-white/10 pb-2 mb-1">
            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Audio Config</span>
            <button id="close-main-settings" class="text-gray-500 hover:text-white p-2"><i data-lucide="x" class="w-4 h-4"></i></button>
        </div>
        <div class="space-y-4">
            <div>
                <div class="flex justify-between text-xs mb-2 text-gray-400"><span>Volume</span><span id="vol-display" class="font-mono text-[10px] text-blue-400">100%</span></div>
                <input type="range" id="vol-slider" min="0" max="100" value="100" class="w-full">
            </div>
            <div>
                <div class="flex justify-between text-xs mb-2 text-gray-400"><span>Crossfade</span><span id="cf-display" class="font-mono text-[10px] text-blue-400">OFF</span></div>
                <input type="range" id="cf-slider" min="0" max="30" value="0" class="w-full">
            </div>
            <div class="pt-2 border-t border-white/10 flex gap-2">
                <button id="btn-save-cfg" class="flex-1 bg-white/10 hover:bg-white/20 text-xs py-3 rounded text-white transition">Save</button>
                <button id="btn-reset-cfg" class="flex-1 bg-red-500/10 hover:bg-red-500/30 text-xs py-3 rounded text-red-300 transition">Reset</button>
            </div>
        </div>
    </div>

    <!-- UI LAYER -->
    <div class="absolute inset-0 z-20 flex flex-col justify-end pointer-events-none p-4 md:p-10">
        <!-- Top Controls -->
        <div class="absolute top-controls flex justify-between items-center pointer-events-auto">
            <!-- Left: Theme Buttons -->
            <div class="flex gap-4 items-center">
                 <!-- Enhanced hit area for better touch -->
                 <button id="theme-red" class="w-5 h-5 rounded-full bg-red-500 shadow-[0_0_12px_rgba(239,68,68,0.4)] active:scale-90 transition-transform"></button>
                 <button id="theme-yellow" class="w-5 h-5 rounded-full bg-yellow-500 shadow-[0_0_12px_rgba(234,179,8,0.4)] active:scale-90 transition-transform"></button>
                 <button id="theme-green" class="w-5 h-5 rounded-full bg-green-500 shadow-[0_0_12px_rgba(34,197,94,0.4)] active:scale-90 transition-transform"></button>
            </div>
            
            <!-- Right: Action Buttons (Config moved here) -->
            <div class="control-btn-group">
                <!-- MOVED: Main Config Button -->
                <button id="btn-toggle-settings" class="glass-btn" title="Audio Settings">
                    <i data-lucide="sliders-horizontal" class="w-5 h-5"></i>
                </button>

                <!-- Viz Button -->
                <button id="btn-toggle-viz" class="glass-btn" title="Visualizer">
                    <i data-lucide="activity" class="w-5 h-5"></i>
                </button>

                <!-- Hide UI -->
                <button id="btn-toggle-dock" class="glass-btn" title="Hide UI">
                    <i id="icon-toggle-dock" data-lucide="eye-off" class="w-5 h-5"></i>
                </button>

                <!-- Playlist -->
                <button id="btn-playlist-toggle" class="glass-btn" title="Playlist">
                    <i data-lucide="list-music" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- Main Dock (Simplifed) -->
        <div class="w-full flex justify-center pointer-events-auto relative mb-2 md:mb-0">
            <div id="main-dock" class="modern-dock px-6 py-5 w-full max-w-2xl flex flex-col gap-3 relative">
                
                <!-- Seek Bar -->
                <div class="flex items-center gap-3 text-[10px] font-mono text-gray-500 mt-2">
                    <span id="current-time" class="w-8 text-right">0:00</span>
                    <input type="range" id="seek-slider" min="0" max="100" value="0" class="flex-grow h-1 opacity-80 hover:opacity-100 transition cursor-pointer py-4">
                    <span id="total-duration" class="w-8">0:00</span>
                </div>

                <!-- Playback Controls -->
                <div class="flex justify-between items-center px-1">
                    <!-- Shuffle (Left) -->
                    <div class="flex items-center">
                        <button id="btn-shuffle" class="btn-icon p-3 rounded-full"><i data-lucide="shuffle" class="w-5 h-5"></i></button>
                    </div>
                    
                    <!-- Center Controls -->
                    <div class="flex items-center gap-4">
                        <button id="btn-prev" class="btn-icon p-2 rounded-full hover:text-white text-gray-400 active:scale-90 transition-transform"><i data-lucide="skip-back" class="w-7 h-7 fill-current"></i></button>
                        <button id="btn-play" class="btn-play w-16 h-16 rounded-full bg-white text-black flex items-center justify-center shadow-lg shadow-white/10 active:scale-95"><i data-lucide="play" class="w-6 h-6 fill-current ml-1"></i></button>
                        <button id="btn-next" class="btn-icon p-2 rounded-full hover:text-white text-gray-400 active:scale-90 transition-transform"><i data-lucide="skip-forward" class="w-7 h-7 fill-current"></i></button>
                    </div>
                    
                    <!-- Right Actions -->
                    <div class="flex items-center gap-1">
                        <button id="btn-repeat" class="btn-icon p-3 rounded-full relative">
                            <i data-lucide="repeat" class="w-5 h-5"></i>
                            <div id="repeat-dot" class="absolute top-3 right-3 w-1.5 h-1.5 bg-blue-500 rounded-full hidden shadow-[0_0_5px_#3b82f6]"></div>
                            <span id="repeat-one" class="absolute top-1 right-1 text-[9px] font-bold text-white hidden">1</span>
                        </button>
                        <label class="btn-icon p-3 rounded-full cursor-pointer active:bg-white/10" title="Add Music">
                            <i data-lucide="folder-plus" class="w-5 h-5"></i>
                            <input type="file" id="file-input" multiple class="hidden">
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Playlist Drawer -->
    <div id="playlist-drawer" class="fixed inset-y-0 right-0 w-80 max-w-[85vw] z-50 flex flex-col closed pointer-events-auto shadow-2xl bg-black">
        <div class="p-6 border-b border-gray-900 flex justify-between items-center bg-black pt-8">
            <h2 class="font-bold text-white text-xs tracking-widest uppercase">Queue</h2>
            <button id="btn-close-playlist" class="text-gray-500 hover:text-white transition p-2"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div id="playlist-container" class="flex-grow overflow-y-auto custom-scrollbar pb-20">
            <div class="h-full flex flex-col items-center justify-center text-gray-700 text-center p-6 space-y-4">
                <div class="w-16 h-16 rounded-full border border-gray-800 flex items-center justify-center"><i data-lucide="music" class="w-6 h-6 opacity-30"></i></div>
                <p class="text-xs uppercase tracking-widest">No Tracks Loaded<br><span class="opacity-50 text-[10px] lowercase normal-case mt-1">Tap folder icon to add</span></p>
            </div>
        </div>
        <div class="p-6 bg-black border-t border-gray-900 text-[10px] text-gray-600 text-center uppercase pb-10">Local Offline Player</div>
    </div>

    <script>
        // --- CORE CONFIG & STATE ---
        let config = { 
            themeColor: '#ffffff', 
            viz: { 
                sensitivity: 2.5, smoothing: 0.6, bars: 80, freqRange: 15, innerRadius: 0.12, barScale: 1.0, 
                rotationSpeed: 0.0002, power: 2.5, glowRadius: 15, glowStrength: 0.6
            }, 
            crossfade: { active: false, duration: 0 },
            volume: 1.0, titleGlow: 20, titleGlowStrength: 0.8
        };
        const state = { 
            playlist: [], currentIndex: -1, isPlaying: false, repeat: 0, shuffle: false, 
            ctx: null, source: null, gain: null, masterGain: null, analyser: null, 
            startTime: 0, duration: 0, triggeredNext: false, loading: false, 
            dockHidden: false, currentVizY: 0.42, rotation: 0, 
            activePill: null // 'viz' or 'main' or null
        };
        
        const $ = (id) => document.getElementById(id);
        const els = {
            title: $('track-title'), artist: $('track-artist'), album: $('track-album'), status: $('player-status'),
            playBtn: $('btn-play'), prevBtn: $('btn-prev'), nextBtn: $('btn-next'), seek: $('seek-slider'), curTime: $('current-time'), durTime: $('total-duration'),
            playlistDrawer: $('playlist-drawer'), playlistContainer: $('playlist-container'), bgCanvas: $('bg-canvas'), artCanvas: $('art-canvas'),
            fileInput: $('file-input'), mainDock: $('main-dock'), 
            toggleDockBtn: $('btn-toggle-dock'), toggleDockIcon: $('icon-toggle-dock'),
            
            // Pills
            toggleVizBtn: $('btn-toggle-viz'), vizPill: $('viz-settings-pill'), closeVizPill: $('close-viz-pill'),
            toggleSettingsBtn: $('btn-toggle-settings'), mainPill: $('main-settings-pill'), closeMainPill: $('close-main-settings'),
            
            vizContainer: $('viz-container'), customPicker: $('custom-theme-picker')
        };

        lucide.createIcons();

        // --- THEME LOGIC (FIXED FOR CLICK COUNT) ---
        function hexToRgb(hex) {
            const bigint = parseInt(hex.slice(1), 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return `${r}, ${g}, ${b}`;
        }

        function updateTheme(hex) {
            config.themeColor = hex; 
            document.documentElement.style.setProperty('--accent', hex);
            document.documentElement.style.setProperty('--accent-rgb', hexToRgb(hex));
            const dot = $('repeat-dot'); if(dot) { dot.style.boxShadow = `0 0 5px ${hex}`; dot.style.backgroundColor = hex; }
        }

        // Custom Click Handler specifically for this requirement
        function attachThemeHandler(elementId, colorHex) {
            const btn = $(elementId);
            let clickCount = 0;
            let clickTimer = null;

            if(!btn) return;

            btn.addEventListener('click', (e) => {
                e.preventDefault(); // Stop zoom behavior
                clickCount++;

                if (clickTimer) clearTimeout(clickTimer);

                clickTimer = setTimeout(() => {
                    // Logic execution after delay
                    if (clickCount === 1) {
                        // 1x Click: Set Color
                        updateTheme(colorHex);
                    } else if (clickCount === 2) {
                        // 2x Click: Set White
                        updateTheme('#ffffff');
                    } else if (clickCount >= 3) {
                        // 3x Click: Custom Picker
                        els.customPicker.click();
                    }
                    
                    // Reset
                    clickCount = 0;
                    clickTimer = null;
                }, 400); // 400ms allowed between clicks
            });
        }

        attachThemeHandler('theme-red', '#ef4444');
        attachThemeHandler('theme-yellow', '#eab308');
        attachThemeHandler('theme-green', '#22c55e');

        if(els.customPicker) {
            els.customPicker.addEventListener('input', (e) => updateTheme(e.target.value));
        }

        // --- CONFIG & PILL MANAGEMENT ---
        function togglePill(pillName) {
            // Close all first
            if (state.activePill && state.activePill !== pillName) {
                if(state.activePill === 'viz') { els.vizPill.classList.remove('active'); els.toggleVizBtn.classList.remove('active-state'); }
                if(state.activePill === 'main') { els.mainPill.classList.remove('active'); els.toggleSettingsBtn.classList.remove('active-state'); }
            }

            if (state.activePill === pillName) {
                // Close current
                if(pillName === 'viz') { els.vizPill.classList.remove('active'); els.toggleVizBtn.classList.remove('active-state'); }
                if(pillName === 'main') { els.mainPill.classList.remove('active'); els.toggleSettingsBtn.classList.remove('active-state'); }
                state.activePill = null;
            } else {
                // Open new
                if(pillName === 'viz') { els.vizPill.classList.add('active'); els.toggleVizBtn.classList.add('active-state'); }
                if(pillName === 'main') { els.mainPill.classList.add('active'); els.toggleSettingsBtn.classList.add('active-state'); }
                state.activePill = pillName;
            }
        }

        els.toggleVizBtn.addEventListener('click', (e) => { e.stopPropagation(); togglePill('viz'); });
        els.closeVizPill.addEventListener('click', () => togglePill('viz'));
        
        els.toggleSettingsBtn.addEventListener('click', (e) => { e.stopPropagation(); togglePill('main'); });
        els.closeMainPill.addEventListener('click', () => togglePill('main'));

        // Close pills when clicking outside
        document.addEventListener('click', (e) => {
            if (state.activePill === 'viz' && !els.vizPill.contains(e.target) && !els.toggleVizBtn.contains(e.target)) togglePill('viz');
            if (state.activePill === 'main' && !els.mainPill.contains(e.target) && !els.toggleSettingsBtn.contains(e.target)) togglePill('main');
        });

        function saveConfig() {
            localStorage.setItem('pba_config_v2', JSON.stringify(config));
            setStatus("CONFIG SAVED");
            setTimeout(() => setStatus(""), 2000);
        }

        function loadConfig() {
            const saved = localStorage.getItem('pba_config_v2');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    Object.assign(config, parsed);
                    applyConfigToUI();
                    updateTheme(config.themeColor);
                } catch (e) { console.error("Config Load Error", e); }
            }
        }

        function applyConfigToUI() {
            // Viz
            if($('inner-radius-slider')) { $('inner-radius-slider').value = config.viz.innerRadius * 100; $('inner-radius-display').innerText = Math.round(config.viz.innerRadius * 100) + '%'; }
            if($('bar-len-slider')) { $('bar-len-slider').value = config.viz.barScale * 100; $('bar-len-display').innerText = Math.round(config.viz.barScale * 100) + '%'; }
            if($('bar-cnt-slider')) { $('bar-cnt-slider').value = config.viz.bars; $('bar-cnt-display').innerText = config.viz.bars; }
            if($('rot-speed-slider')) $('rot-speed-slider').value = config.viz.rotationSpeed * 10000 / 2;
            if($('pill-sens-slider')) { $('pill-sens-slider').value = config.viz.sensitivity * 10; $('pill-sens-display').innerText = config.viz.sensitivity + 'x'; }
            
            // Audio
            if($('cf-slider')) { $('cf-slider').value = config.crossfade.duration; $('cf-display').innerText = config.crossfade.duration > 0 ? `${config.crossfade.duration}s` : "OFF"; }
            if($('vol-slider')) { $('vol-slider').value = config.volume * 100; $('vol-display').innerText = Math.round(config.volume * 100) + '%'; }
            if(state.masterGain) state.masterGain.gain.value = config.volume;
        }

        // --- AUDIO ENGINE ---
        function initAudio() {
            if (!state.ctx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                state.ctx = new AudioContext();
                state.masterGain = state.ctx.createGain();
                state.masterGain.gain.value = config.volume;
                state.masterGain.connect(state.ctx.destination);
                state.analyser = state.ctx.createAnalyser();
                state.analyser.fftSize = 1024;
                state.analyser.connect(state.masterGain);
                state.analyser.smoothingTimeConstant = config.viz.smoothing;
                startVisualizer();
            }
            if (state.ctx.state === 'suspended') state.ctx.resume();
        }
        
        document.body.addEventListener('touchstart', () => { if (!state.ctx) initAudio(); else if (state.ctx.state === 'suspended') state.ctx.resume(); }, { once: true });
        document.body.addEventListener('click', initAudio, { once: true });

        async function getAudioBuffer(file) {
             const arrayBuffer = await file.arrayBuffer();
             return await state.ctx.decodeAudioData(arrayBuffer);
        }

        function setStatus(msg) {
            if (els.status) { els.status.innerText = msg; els.status.style.opacity = msg ? 1 : 0; }
        }

        function updateInfo(file) {
            const cleanName = file.name.replace(/\.[^/.]+$/, "");
            els.title.innerText = cleanName; els.artist.innerText = "Unknown Artist"; els.album.innerText = ""; els.album.classList.add('opacity-0');
            const oldTitle = els.title;
            const newTitle = oldTitle.cloneNode(true);
            oldTitle.parentNode.replaceChild(newTitle, oldTitle);
            els.title = newTitle;
            if (window.jsmediatags) {
                window.jsmediatags.read(file, {
                    onSuccess: function(tag) {
                        if (tag.tags.title) els.title.innerText = tag.tags.title;
                        if (tag.tags.artist) els.artist.innerText = tag.tags.artist;
                        if (tag.tags.album) { els.album.innerText = tag.tags.album; els.album.classList.remove('opacity-0'); }
                    },
                    onError: () => {}
                });
            }
        }

        async function playTrack(index, offset = 0) {
            initAudio();
            if (index < 0 || index >= state.playlist.length) return;
            if (state.currentIndex === index && offset === 0 && state.isPlaying) return; 
            state.loading = true; setStatus("LOADING...");
            const file = state.playlist[index];
            if(state.currentIndex !== index) { updateInfo(file); state.currentIndex = index; renderPlaylist(); }
            els.playBtn.innerHTML = `<div class="w-4 h-4 border-2 border-gray-500 border-t-transparent rounded-full animate-spin"></div>`;
            try {
                setStatus("DECODING..."); const buffer = await getAudioBuffer(file); setStatus("PLAYING");
                const isSeeking = offset > 0;
                let fadeDuration = (config.crossfade.active && !isSeeking) ? config.crossfade.duration : 0;
                fadeDuration = Math.min(fadeDuration, buffer.duration);
                const now = state.ctx.currentTime;
                if (state.source && state.gain) {
                    const oldSource = state.source; const oldGain = state.gain;
                    oldGain.gain.cancelScheduledValues(now); oldGain.gain.setValueAtTime(oldGain.gain.value, now);
                    if (fadeDuration > 0) { oldGain.gain.linearRampToValueAtTime(0, now + fadeDuration); oldSource.stop(now + fadeDuration + 0.1); } 
                    else { oldGain.gain.linearRampToValueAtTime(0, now + 0.05); oldSource.stop(now + 0.05); }
                }
                const src = state.ctx.createBufferSource(); const gain = state.ctx.createGain();
                src.buffer = buffer; src.connect(gain); gain.connect(state.analyser);
                if (fadeDuration > 0) { gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(1, now + fadeDuration); } else { gain.gain.setValueAtTime(1, now); }
                src.start(0, offset);
                state.source = src; state.gain = gain; state.isPlaying = true;
                state.startTime = now - offset; state.duration = buffer.duration;
                state.triggeredNext = false; state.loading = false;
                updateControls(); setTimeout(() => setStatus(""), 2000);
            } catch (err) {
                console.error("Playback Error:", err); setStatus("ERROR"); state.isPlaying = false; state.loading = false; updateControls(); 
            }
        }

        function togglePlay() {
            if (!state.ctx) return;
            if (state.isPlaying) { state.ctx.suspend(); state.isPlaying = false; }
            else { if (state.ctx.state === 'suspended') state.ctx.resume(); state.isPlaying = true; if (state.currentIndex === -1 && state.playlist.length > 0) playTrack(0); }
            updateControls();
        }

        function uiLoop() {
            if(state.isPlaying && state.ctx && !state.loading) {
                const currentTime = state.ctx.currentTime - state.startTime;
                if(document.activeElement !== els.seek) {
                    if(currentTime <= state.duration) {
                        const pct = (currentTime / state.duration) * 100;
                        els.seek.value = pct; els.seek.style.setProperty('--progress', `${pct}%`);
                        els.curTime.innerText = formatTime(currentTime);
                    }
                }
                els.durTime.innerText = formatTime(state.duration);
                const remaining = state.duration - currentTime;
                const fadeDur = config.crossfade.active ? config.crossfade.duration : 0;
                if (!state.triggeredNext && remaining <= fadeDur && remaining > -0.5) { state.triggeredNext = true; nextTrack(true); }
            }
            requestAnimationFrame(uiLoop);
        }
        uiLoop();

        function nextTrack(auto = false) {
            let next = state.currentIndex + 1;
            if (state.repeat === 2 && auto) next = state.currentIndex;
            else if (state.shuffle) next = Math.floor(Math.random() * state.playlist.length);
            if (next >= state.playlist.length) {
                if (state.repeat > 0) next = 0;
                else { if(auto && config.crossfade.active && config.crossfade.duration > 0) {} else if (auto) { state.isPlaying = false; state.ctx.suspend(); updateControls(); } return; }
            }
            playTrack(next);
        }

        // --- VISUALIZER ---
        function startVisualizer() {
            const artCtx = els.artCanvas.getContext('2d'); const bgCtx = els.bgCanvas.getContext('2d');
            const dataArray = new Uint8Array(state.analyser.frequencyBinCount);
            function resize() { 
                els.bgCanvas.width = window.innerWidth; 
                els.bgCanvas.height = window.innerHeight; 
                els.artCanvas.width = window.innerWidth; 
                els.artCanvas.height = window.innerHeight; 
            }
            window.addEventListener('resize', resize); resize();
            
            function draw() {
                requestAnimationFrame(draw);
                if (state.analyser) state.analyser.smoothingTimeConstant = config.viz.smoothing;
                if (state.isPlaying && state.ctx.state === 'running') state.analyser.getByteFrequencyData(dataArray); else for(let i=0; i<dataArray.length; i++) dataArray[i] = Math.max(0, dataArray[i] - 5);
                const w = window.innerWidth; const h = window.innerHeight;
                const targetY = state.dockHidden ? 0.5 : 0.42; state.currentVizY += (targetY - state.currentVizY) * 0.05; const cx = w / 2; const cy = h * state.currentVizY;
                artCtx.clearRect(0, 0, w, h); bgCtx.clearRect(0, 0, w, h);
                let bassSum = 0; for(let i=0; i<4; i++) bassSum += dataArray[i]; const bassAvg = (bassSum / 4) / 255;
                const pulseOp = (bassAvg * 0.2 * config.viz.sensitivity);
                bgCtx.fillStyle = `rgba(255, 255, 255, ${Math.min(pulseOp, 0.1)})`; bgCtx.beginPath(); bgCtx.arc(cx, cy, w * 0.4, 0, Math.PI * 2); bgCtx.fill();
                const minDim = Math.min(w, h); const baseInnerRadius = minDim * config.viz.innerRadius; const innerKick = Math.pow(bassAvg, 3) * (minDim * 0.05) * config.viz.sensitivity; const currentInnerRadius = baseInnerRadius + innerKick;
                const barRadius = currentInnerRadius; const extraBarKick = Math.pow(bassAvg, 4) * 20 * config.viz.sensitivity; const barCount = config.viz.bars; const step = (Math.PI * 2) / barCount; const maxBin = parseInt(config.viz.freqRange);
                state.rotation += config.viz.rotationSpeed; artCtx.translate(cx, cy); artCtx.rotate(state.rotation); artCtx.strokeStyle = 'white'; artCtx.lineCap = 'round';
                artCtx.shadowBlur = config.viz.glowRadius; artCtx.shadowColor = config.themeColor === '#ffffff' ? `rgba(255,255,255,${config.viz.glowStrength})` : config.themeColor;
                for (let i = 0; i < barCount; i++) {
                    const dataIndex = Math.floor((i / barCount) * maxBin); const val = dataArray[dataIndex] / 255;
                    const barH = (Math.pow(val, config.viz.power) * (Math.min(w,h) * 0.25) * config.viz.sensitivity * config.viz.barScale) + extraBarKick;
                    artCtx.save(); artCtx.rotate(i * step);
                    if (barH > 2) {
                        artCtx.beginPath(); artCtx.moveTo(0, barRadius); artCtx.lineTo(0, barRadius + barH); artCtx.lineWidth = 1 + (val * 3);
                        if (config.themeColor === '#ffffff') artCtx.strokeStyle = `rgba(255, 255, 255, ${val * 0.9})`; else { artCtx.strokeStyle = val > 0.8 ? `rgba(255, 255, 255, ${val})` : config.themeColor; if(val <= 0.8) artCtx.globalAlpha = val; }
                        artCtx.stroke(); artCtx.globalAlpha = 1;
                        if(val > 0.5) { artCtx.beginPath(); artCtx.moveTo(0, barRadius - 5); artCtx.lineTo(0, barRadius - 5 - (barH * 0.2)); artCtx.strokeStyle = `rgba(255, 255, 255, 0.2)`; artCtx.stroke(); }
                    }
                    artCtx.restore();
                }
                artCtx.shadowBlur = 0; 
                artCtx.beginPath(); artCtx.arc(0, 0, currentInnerRadius, 0, Math.PI * 2); artCtx.fillStyle = '#000000'; artCtx.fill();
                artCtx.beginPath(); artCtx.arc(0, 0, currentInnerRadius, 0, Math.PI * 2); artCtx.strokeStyle = config.themeColor === '#ffffff' ? `rgba(255, 255, 255, ${0.1 + bassAvg * 0.3})` : config.themeColor; artCtx.lineWidth = 2; artCtx.stroke(); artCtx.setTransform(1, 0, 0, 1, 0, 0); 
            }
            draw();
        }

        // --- CONTROLS & LISTENERS ---
        function updateControls() {
            els.playBtn.innerHTML = state.isPlaying 
                ? `<i data-lucide="pause" class="w-6 h-6 fill-current"></i>`
                : `<i data-lucide="play" class="w-6 h-6 fill-current ml-1"></i>`;
            lucide.createIcons();
            $('repeat-dot').classList.toggle('hidden', state.repeat === 0);
            $('repeat-one').classList.toggle('hidden', state.repeat !== 2);
            $('btn-shuffle').classList.toggle('text-white', state.shuffle);
            $('btn-shuffle').classList.toggle('text-gray-400', !state.shuffle);
        }

        function renderPlaylist() {
            els.playlistContainer.innerHTML = '';
            state.playlist.forEach((f, i) => {
                const div = document.createElement('div');
                div.className = `playlist-item p-4 cursor-pointer flex justify-between items-center transition hover:bg-white/5 active:bg-white/10 ${i === state.currentIndex ? 'active' : ''}`;
                div.innerHTML = `<div class="flex items-center gap-3 overflow-hidden pointer-events-none"><div class="status-indicator w-2 h-2 rounded-full bg-gray-800 transition-colors"></div><span class="truncate text-sm font-medium ${i === state.currentIndex ? 'text-white' : 'text-gray-400'}">${f.name}</span></div>`;
                div.onclick = (e) => { playTrack(i); };
                els.playlistContainer.appendChild(div);
            });
             if (state.playlist.length === 0) {
                 els.playlistContainer.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-gray-700 text-center p-6 space-y-4"><div class="w-16 h-16 rounded-full border border-gray-800 flex items-center justify-center"><i data-lucide="music" class="w-6 h-6 opacity-30"></i></div><p class="text-xs uppercase tracking-widest">No Tracks Loaded<br><span class="opacity-50 text-[10px] lowercase normal-case mt-1">Tap folder icon to add</span></p></div>`;
                 lucide.createIcons();
            }
        }

        function formatTime(s) { if(isNaN(s)) return "0:00"; const m = Math.floor(s / 60); const sc = Math.floor(s % 60); return `${m}:${sc < 10 ? '0' : ''}${sc}`; }

        // Setting Listeners
        if($('inner-radius-slider')) $('inner-radius-slider').addEventListener('input', (e) => { const val = parseInt(e.target.value); config.viz.innerRadius = val / 100; $('inner-radius-display').innerText = val + '%'; });
        if($('bar-len-slider')) $('bar-len-slider').addEventListener('input', (e) => { const val = parseInt(e.target.value); config.viz.barScale = val / 100; $('bar-len-display').innerText = val + '%'; });
        if($('bar-cnt-slider')) $('bar-cnt-slider').addEventListener('input', (e) => { const val = parseInt(e.target.value); config.viz.bars = val; $('bar-cnt-display').innerText = val; });
        if($('rot-speed-slider')) $('rot-speed-slider').addEventListener('input', (e) => { const val = parseInt(e.target.value); config.viz.rotationSpeed = val * 0.0001; $('rot-speed-display').innerText = (val * 0.1).toFixed(1) + 'x'; });
        if($('pill-sens-slider')) $('pill-sens-slider').addEventListener('input', (e) => { const val = parseInt(e.target.value); config.viz.sensitivity = val / 10; $('pill-sens-display').innerText = config.viz.sensitivity + 'x'; });
        
        if($('cf-slider')) $('cf-slider').addEventListener('input', (e) => { config.crossfade.duration = parseInt(e.target.value); config.crossfade.active = config.crossfade.duration > 0; $('cf-display').innerText = config.crossfade.duration > 0 ? `${config.crossfade.duration}s` : "OFF"; });
        if($('vol-slider')) $('vol-slider').addEventListener('input', (e) => { const val = parseFloat(e.target.value); config.volume = val / 100; $('vol-display').innerText = val + '%'; if(state.masterGain) state.masterGain.gain.value = config.volume; });

        if($('btn-save-cfg')) $('btn-save-cfg').addEventListener('click', saveConfig);
        if($('btn-reset-cfg')) $('btn-reset-cfg').addEventListener('click', () => { localStorage.removeItem('pba_config_v2'); location.reload(); });

        els.seek.addEventListener('input', (e) => { const pct = parseFloat(e.target.value); const time = (pct / 100) * state.duration; els.curTime.innerText = formatTime(time); els.seek.style.setProperty('--progress', `${pct}%`); });
        els.seek.addEventListener('change', (e) => { if (state.currentIndex !== -1) { const pct = parseFloat(e.target.value); const seekTime = (pct / 100) * state.duration; playTrack(state.currentIndex, seekTime); }});
        
        els.toggleDockBtn.addEventListener('click', () => { state.dockHidden = !state.dockHidden; els.mainDock.classList.toggle('dock-hidden', state.dockHidden); els.vizContainer.classList.toggle('immersive', state.dockHidden); els.toggleDockIcon.setAttribute('data-lucide', state.dockHidden ? 'eye' : 'eye-off'); lucide.createIcons(); });
        
        $('btn-playlist-toggle').addEventListener('click', () => els.playlistDrawer.classList.remove('closed'));
        $('btn-close-playlist').addEventListener('click', () => els.playlistDrawer.classList.add('closed'));
        els.playBtn.addEventListener('click', togglePlay);
        els.nextBtn.addEventListener('click', () => nextTrack(false));
        els.prevBtn.addEventListener('click', () => { let prev = state.currentIndex - 1; if(prev < 0) prev = state.playlist.length - 1; playTrack(prev); });
        $('btn-repeat').addEventListener('click', () => { state.repeat = (state.repeat + 1) % 3; updateControls(); });
        $('btn-shuffle').addEventListener('click', () => { state.shuffle = !state.shuffle; updateControls(); });

        els.fileInput.addEventListener('change', (e) => { const files = Array.from(e.target.files); if (files.length === 0) return; const wasEmpty = state.playlist.length === 0; state.playlist = [...state.playlist, ...files]; renderPlaylist(); els.playlistDrawer.classList.remove('closed'); if (wasEmpty || (!state.isPlaying && state.currentIndex === -1)) playTrack(state.playlist.length - files.length); els.fileInput.value = ''; });

        loadConfig();
    </script>
</body>
</html>


